//@ts-check
import getScrollInfo from "get-scroll-info";
import get from "get-object-value";
import { UNDEFINED, OBJ_SIZE } from "reshow-constant";

/**
 * @typedef {object} Coordinate
 * @property {number} [x]
 * @property {number} [y]
 */

/**
 * @param {object} e
 */
var unifyTouch = function unifyTouch(e) {
  return e && e.changedTouches ? get(e, ["changedTouches", 0]) : e;
};

/**
 * @param {object} e
 * @param {HTMLElement} dom
 * @param {HTMLElement} scrollNode
 * @returns {[number, number]}
 */
var mouse = function mouse(e, dom, scrollNode) {
  if (!dom) {
    dom = e.currentTarget || e.target;
  }
  e = unifyTouch(e);
  var x = e.clientX;
  var y = e.clientY;
  var svgXY = toSvgXY(dom)(x, y);
  if (OBJ_SIZE(svgXY)) {
    var {
      x: svgX,
      y: svgY
    } = svgXY;
    return [svgX, svgY];
  } else {
    var domXY = getOffset(dom, scrollNode);
    /**
     * dom.clientLeft
     *
     * https://www.w3schools.com/jsref/prop_element_clientleft.asp
     */
    return [x - domXY.left - dom.clientLeft, y - domXY.top - dom.clientTop];
  }
};

/**
 * @param {object} dom
 * @param {object} zoom
 */
var toSvgXY = function toSvgXY(dom, zoom) {
  return (
    /**
     * @param {number} x
     * @param {number} y
     * @returns {Coordinate}
     */
    function (x, y) {
      var svg = dom.ownerSVGElement || dom;
      if (svg.createSVGPoint) {
        var point = svg.createSVGPoint();
        point.x = x;
        point.y = y;
        point = point.matrixTransform(dom.getScreenCTM().inverse());
        return getZoomXY(zoom)(point.x, point.y);
      } else {
        return {};
      }
    }
  );
};

/**
 * @param {object} dom
 * @param {object} zoom
 */
var getSvgMatrixXY = function getSvgMatrixXY(dom, zoom) {
  return (
    /**
     * @param {number} x
     * @param {number} y
     * @returns {Coordinate}
     */
    function (x, y) {
      var svg = dom.ownerSVGElement || dom;
      if (svg.getScreenCTM) {
        var {
          a,
          b,
          c,
          d,
          e,
          f
        } = dom.getScreenCTM();
        var {
          left,
          top
        } = svg.getBoundingClientRect();
        var svgX = a * x + c * y + e - left;
        var svgY = b * x + d * y + f - top;
        return getZoomXY(zoom)(svgX, svgY);
      }
    }
  );
};

/**
 * @param {object} zoom
 */
var getZoomXY = function getZoomXY(zoom) {
  return (
    /**
     * @param {number} x
     * @param {number} y
     * @returns {Coordinate}
     */
    function (x, y) {
      if (!zoom) {
        return {
          x,
          y
        };
      }
      var zoomK = get(zoom, ["k"], 1);
      var zoomX = get(zoom, ["x"], 0);
      var zoomY = get(zoom, ["y"], 0);
      var zx = (x - zoomX) / zoomK;
      var zy = (y - zoomY) / zoomK;
      return {
        x: zx,
        y: zy
      };
    }
  );
};

/**
 * @param {object} dom
 * @returns {Coordinate}
 */
var getRectWithElOffset = function getRectWithElOffset(dom) {
  var x = 0;
  var y = 0;
  var el = dom;
  do {
    var offsetTop = el.offsetTop || 0;
    var offsetLeft = el.offsetLeft || 0;
    if ("BODY" === el.nodeName) {
      x += offsetLeft;
      y += offsetTop;
    } else {
      x += offsetLeft - el.scrollLeft;
      y += offsetTop - el.scrollTop;
    }
    el = el.offsetParent;
  } while (el);
  return {
    x,
    y
  };
};

/**
 * @typedef {object} Offset
 * @property {object} rect
 * @property {object} scrollInfo
 * @property {number} w
 * @property {number} h
 * @property {number} width
 * @property {number} height
 * @property {number} x
 * @property {number} y
 * @property {number} top
 * @property {number} right
 * @property {number} bottom
 * @property {number} left
 */

/**
 * @param {HTMLElement} dom
 * @param {HTMLElement|number} scrollNode
 * @returns {Offset}
 */
var getOffset = function getOffset(dom, scrollNode) {
  if (scrollNode === void 0) {
    scrollNode = null;
  }
  if (!dom) {
    return;
  }
  var top = 0;
  var left = 0;
  var w;
  var h;
  var rect;
  var scrollInfo = 0 === scrollNode ? {
    top: 0,
    left: 0
  } : getScrollInfo(scrollNode);
  if (UNDEFINED !== typeof SVGElement && dom instanceof SVGElement) {
    rect = dom.getBoundingClientRect();
    top = rect.top + scrollInfo.top;
    left = rect.left + scrollInfo.left;
    w = rect.width;
    h = rect.height;
  } else {
    w = dom.offsetWidth;
    h = dom.offsetHeight;
    if (dom.getBoundingClientRect) {
      rect = dom.getBoundingClientRect();
      top = (rect.top + scrollInfo.top) * 1;
      left = (rect.left + scrollInfo.left) * 1;
    } else {
      var rectOffset = getRectWithElOffset(dom);
      top = rectOffset.y;
      left = rectOffset.x;
    }
  }
  var result = {
    rect,
    scrollInfo,
    w,
    h,
    width: w,
    height: h,
    x: left,
    y: top,
    top,
    right: left + w,
    bottom: top + h,
    left
  };
  return result;
};
export { mouse, toSvgXY, getSvgMatrixXY, unifyTouch };
export default getOffset;