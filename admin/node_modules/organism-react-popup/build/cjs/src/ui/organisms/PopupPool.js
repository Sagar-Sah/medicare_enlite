"use strict";

var _interopRequireDefault = require("reshow-runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("reshow-runtime/helpers/interopRequireWildcard");

exports.__esModule = true;
exports["default"] = void 0;

var _objectSpread2 = _interopRequireDefault(require("reshow-runtime/helpers/objectSpread2"));

var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("reshow-runtime/helpers/objectWithoutPropertiesLoose"));

var _react = require("react");

var _reactAtomicMolecule = require("react-atomic-molecule");

var _reshowReturn = require("reshow-return");

var _reshowFlux = require("reshow-flux");

var _popupStore = _interopRequireWildcard(require("../../stores/popupStore.js"));

var _excluded = ["component", "name"];

/**
 * @param {Immutable.Map} nodes
 * @param {string} name
 * @returns {Immutable.Map}
 */
var getPops = function getPops(nodes, name) {
  var pops = nodes;
  nodes.forEach(function (v, k) {
    var _v$props;

    var toPool = (_v$props = v.props) === null || _v$props === void 0 ? void 0 : _v$props.toPool;

    if ((name || toPool) && toPool !== name) {
      pops = pops["delete"](k);
    }
  });
  return pops;
};

var PopupPool = function PopupPool(_ref) {
  var _ref$component = _ref.component,
      component = _ref$component === void 0 ? _reactAtomicMolecule.SemanticUI : _ref$component,
      _ref$name = _ref.name,
      name = _ref$name === void 0 ? null : _ref$name,
      restProps = (0, _objectWithoutPropertiesLoose2["default"])(_ref, _excluded);

  var _usePartialRender = (0, _reshowReturn.usePartialRender)(),
      renderComponent = _usePartialRender[0],
      partialRender = _usePartialRender[1],
      setRenderKeys = _usePartialRender[2];

  var state = (0, _reshowReturn.useReturn)([_popupStore.NODE_KEY, _popupStore.SHOW_NEXT], _popupStore["default"]);
  (0, _react.useEffect)(function () {
    var nextPopNodes = getPops(state[_popupStore.NODE_KEY], name);
    var popsKeys = nextPopNodes.keySeq();
    setRenderKeys(
    /**
     * @param {Array} prev
     */
    function (prev) {
      return !(0, _reshowFlux.equal)(prev, popsKeys) ? popsKeys : prev;
    });
    var updateKey = state[_popupStore.SHOW_NEXT];

    if (nextPopNodes.has(updateKey)) {
      var _partialRender;

      partialRender((_partialRender = {}, _partialRender[updateKey] = nextPopNodes.get(updateKey), _partialRender));
    }
  }, [state[_popupStore.NODE_KEY]]);
  return (0, _react.useMemo)(function () {
    return (0, _reactAtomicMolecule.build)(component)((0, _objectSpread2["default"])((0, _objectSpread2["default"])({}, restProps), {}, {
      name: name,
      className: (0, _reactAtomicMolecule.mixClass)(name, "popup-pool"),
      ui: false
    }), renderComponent);
  }, [renderComponent]);
};

var _default = PopupPool;
exports["default"] = _default;
module.exports = exports.default;