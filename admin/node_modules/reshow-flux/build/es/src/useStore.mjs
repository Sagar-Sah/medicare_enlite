import _objectSpread from "reshow-runtime/es/helpers/objectSpread2";
import { useSyncExternalStore, useCallback, useRef } from "react";
/**
 * How to use?
 *
 *  import { useEffect } from "react";
 *  import { useStore, ImmutableStore } from "reshow-flux";
 *  const [store, dispatch] = ImmutableStore();
 *  const Comp = props => {
 *    const state = useStore(store);
 *    useEffect(()=>dispatch({foo: "bar"}), []);
 *    return <div>{state.get("foo")}</div>;
 *  }
 */

var useStore = function useStore(store, heeding) {
  var lastEmit = useRef();

  if (!lastEmit.current) {
    lastEmit.current = {
      /**
       * Pass empty {} to heeding, that easy use
       * if(!emit.current){return initState;}
       * inside heeding.
       */
      state: heeding ? heeding({}) : store.getState()
    };
  }

  var subscribe = useCallback(function (notify) {
    var myHeeding = heeding || function (emit) {
      emit.current.state = emit.current.storeState;
      emit.current.notify();
    };

    var myListener = function myListener(storeState, action, prevStoreState) {
      lastEmit.current = _objectSpread(_objectSpread({}, lastEmit.current), {}, {
        storeState,
        action,
        prevStoreState,
        notify
      });
      myHeeding(lastEmit);
    };

    store.addListener(myListener);
    return function () {
      return store.removeListener(myListener);
    };
  }, [store, heeding]);

  var getState = function getState() {
    return lastEmit.current.state;
  };

  return useSyncExternalStore(subscribe, getState, getState);
};

export default useStore;