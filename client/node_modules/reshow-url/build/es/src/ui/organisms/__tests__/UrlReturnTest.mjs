import _asyncToGenerator from "reshow-runtime/es/helpers/asyncToGenerator";
import _classCallCheck from "reshow-runtime/es/helpers/classCallCheck";
import _createClass from "reshow-runtime/es/helpers/createClass";
import _assertThisInitialized from "reshow-runtime/es/helpers/assertThisInitialized";
import _inherits from "reshow-runtime/es/helpers/inherits";
import _createSuper from "reshow-runtime/es/helpers/createSuper";
import _defineProperty from "reshow-runtime/es/helpers/defineProperty";

var _div;

import { PureComponent } from "react";
import { expect } from "chai";
import { act, render, cleanIt, jsdom, waitFor } from "reshow-unit";
import urlStore, { urlDispatch } from "../../../stores/urlStore.mjs";
import UrlReturn from "../UrlReturn.mjs";
import { jsx as _jsx } from "react/jsx-runtime";
describe("Test Url Return", function () {
  var _FakeComponent, _FakeComponent2, _FakeComponent3;

  beforeEach(function () {
    jsdom(null, {
      url: "http://localhost"
    });
    urlStore.reset();
  });
  afterEach(function () {
    cleanIt();
  });

  var TestEl = /*#__PURE__*/function (_PureComponent) {
    _inherits(TestEl, _PureComponent);

    var _super = _createSuper(TestEl);

    function TestEl() {
      var _this;

      _classCallCheck(this, TestEl);

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      _this = _super.call.apply(_super, [this].concat(args));

      _defineProperty(_assertThisInitialized(_this), "show", 0);

      return _this;
    }

    _createClass(TestEl, [{
      key: "render",
      value: function render() {
        this.show++;
        return _div || (_div = /*#__PURE__*/_jsx("div", {}));
      }
    }]);

    return TestEl;
  }(PureComponent);

  var uFake;

  var FakeComponent = /*#__PURE__*/function (_PureComponent2) {
    _inherits(FakeComponent, _PureComponent2);

    var _super2 = _createSuper(FakeComponent);

    function FakeComponent(props) {
      var _this2;

      _classCallCheck(this, FakeComponent);

      _this2 = _super2.call(this, props);
      uFake = _assertThisInitialized(_this2);
      return _this2;
    }

    _createClass(FakeComponent, [{
      key: "render",
      value: function render() {
        var _this3 = this;

        var {
          urlKey
        } = this.props;
        return /*#__PURE__*/_jsx(UrlReturn, {
          initStates: [urlKey],
          children: /*#__PURE__*/_jsx(TestEl, {
            ref: function ref(el) {
              return _this3.el = el;
            }
          })
        });
      }
    }]);

    return FakeComponent;
  }(PureComponent);

  it("test get pathname", /*#__PURE__*/_asyncToGenerator(function* () {
    render(_FakeComponent || (_FakeComponent = /*#__PURE__*/_jsx(FakeComponent, {
      urlKey: ":pathname"
    })));
    yield act(function () {
      return urlDispatch({
        type: "url",
        url: "http://localhost/aaa"
      });
    }, 5);
    expect(uFake.el.props[":pathname"]).to.deep.equal(["", "aaa"]);
  }));
  it("test get query", /*#__PURE__*/_asyncToGenerator(function* () {
    render(_FakeComponent2 || (_FakeComponent2 = /*#__PURE__*/_jsx(FakeComponent, {
      urlKey: "foo"
    })));
    yield act(function () {
      return urlDispatch({
        type: "query",
        params: {
          foo: "bar"
        }
      });
    }, 5);
    yield waitFor(function () {
      return expect(uFake.el.props["foo"]).to.equal("bar");
    });
  }));
  it("test trigger by history", /*#__PURE__*/_asyncToGenerator(function* () {
    yield act(function () {
      return render(_FakeComponent3 || (_FakeComponent3 = /*#__PURE__*/_jsx(FakeComponent, {
        urlKey: ":pathname"
      })));
    }, 5);
    urlStore.registerEvent(window);
    window.history.pushState(null, "title", "http://localhost/bbb");
    window.history.pushState(null, "title", "http://localhost/ccc");
    window.history.back();
    waitFor(function () {
      expect(uFake.el.props[":pathname"]).to.deep.equal(["", "bbb"]);
    });
  }));
});